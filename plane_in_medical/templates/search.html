<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ»é£é€Ÿè¾¾ - æœç´¢ç»“æœ</title>
  <style>
    /* å…¨å±€æ ·å¼ */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      color: #333;
    }

    /* å¯¼èˆªæ æ ·å¼ */
    nav {
      background-color: #007bff;
      color: white;
      padding: 15px;
      text-align: center;
    }

    /* ä¸»è¦å†…å®¹åŒºåŸŸæ ·å¼ */
    .main-content {
      padding: 20px;
      max-width: 1000px;
      margin: 0 auto;
    }

    h2 {
      color: #007bff;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }

    /* æœç´¢ç»“æœåˆ—è¡¨æ ·å¼ */
    .search-results {
      list-style-type: none;
      padding: 0;
    }

    .search-results li {
      background-color: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease-in-out;
      display: flex;
      align-items: flex-start;
    }

    .search-results li:hover {
      transform: translateY(-5px);
    }

    .search-results img {
      max-width: 100px;
      margin-right: 20px;
      border-radius: 4px;
    }

    .search-results .info {
      flex: 1;
    }

    .search-results h3 {
      margin-top: 0;
      color: #0056b3;
    }

    .search-results p {
      line-height: 1.6;
    }

    .search-results .price {
      color: #e53935;
      font-weight: bold;
      font-size: 18px;
    }

    /* åŠ å…¥è´­ç‰©è½¦æŒ‰é’®æ ·å¼ */
    .add-to-cart-button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }

    .add-to-cart-button:hover {
      background-color: #218838;
    }

    /* å·²åœ¨è´­ç‰©è½¦æŒ‰é’®æ ·å¼ */
    .in-cart-button {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin-top: 10px;
      cursor: not-allowed;
      border-radius: 4px;
    }

    /* é¡µè„šæ ·å¼ */
    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 15px;
      margin-top: 20px;
    }

    /* æç¤ºæ¡†æ ·å¼ */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      display: none;
    }

    .alert-success {
      background-color: #28a745;
    }

    .alert-error {
      background-color: #dc3545;
    }

    /* è´­ç‰©è½¦å…¥å£æ ·å¼ */
    .cart-entry {
      position: fixed;
      bottom: 60px;
      right: 20px;
      width: 54px;
      height: 54px;
      background: #007bff;
      border-radius: 50%;
      text-align: center;
      line-height: 54px;
      font-size: 22px;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
      cursor: pointer;
      z-index: 999;
      transition: transform 0.2s;
    }

    .cart-entry:hover {
      transform: scale(1.1);
    }

    .cart-count {
      position: absolute;
      top: 0;
      right: 0;
      background: #ff4757;
      color: #fff;
      font-size: 12px;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      border-radius: 9px;
      padding: 0 4px;
    }

    /* æç¤ºä¿¡æ¯æ ·å¼ */
    .cart-tip {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,.7);
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      display: none;
      z-index: 9999;
    }
  </style>
</head>

<body>
  {% include "ceil.html" %}
  <!-- æç¤ºæ¡† -->
  <div id="alert-message" class="alert"></div>
  
  <!-- è´­ç‰©è½¦å…¥å£ -->
  <div class="cart-entry">
    <span class="cart-count">0</span>
    <a href="/cart_view/" aria-label="æŸ¥çœ‹è´­ç‰©è½¦" style="color: white; text-decoration: none;">ğŸ›’</a>
  </div>
  
  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <div class="main-content">
    <h2>æœç´¢ç»“æœ</h2>
    {% if medicine_data %}
    <ul class="search-results">
      {% for item in medicine_data %}
      <li>
        {% if item.image %}
        <img src="{{ item.image }}" alt="{{ item.name }}">
        {% endif %}
        <div class="info">
          <h3>{{ item.name }}</h3>
          <p>{{ item.introduction }}</p>
          <p class="price">ä»·æ ¼: Â¥{{ item.price }}</p>
          <!-- åŠ å…¥è´­ç‰©è½¦æŒ‰é’® -->
          <button class="add-to-cart-button" data-medicine-id="{{ item.id }}">åŠ å…¥è´­ç‰©è½¦</button>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯å“ã€‚</p>
    {% endif %}
  </div>

  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯çš„å‡½æ•°
    function showAlert(message, isSuccess) {
      const alertBox = $('#alert-message');
      alertBox.removeClass('alert-success alert-error');
      alertBox.addClass(isSuccess ? 'alert-success' : 'alert-error');
      alertBox.text(message);
      alertBox.fadeIn();
      
      setTimeout(function() {
        alertBox.fadeOut();
      }, 3000);
    }

    // æ˜¾ç¤ºé¡¶éƒ¨æç¤ºä¿¡æ¯
    function showTip(text) {
      const $tip = $(`<div class="cart-tip">${text}</div>`);
      $('body').append($tip);
      $tip.fadeIn(200).delay(1200).fadeOut(400, () => $tip.remove());
    }

    // è·å–CSRF Token
    function getCSRFToken() {
      return $('input[name=csrfmiddlewaretoken]').val();
    }

    // æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
    function addToCart(medicineId, quantity = 1) {
      return fetch('/add_to_cart/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
          medicine_id: medicineId,
          quantity: quantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showTip('å•†å“æˆåŠŸåŠ å…¥è´­ç‰©è½¦ï¼');
          updateCartCount(data.item_count);
          return true;
        } else {
          showTip('æ·»åŠ å¤±è´¥: ' + data.message);
          return false;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showTip('æ·»åŠ å¤±è´¥');
        return false;
      });
    }

    // æ›´æ–°è´­ç‰©è½¦è®¡æ•°
    function updateCartCount(count) {
      $('.cart-count').text(count);
    }

    // è·å–è´­ç‰©è½¦å•†å“æ•°é‡
    function getCartItemCount() {
      fetch('/cart_info/', {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.headers.get('content-type') && 
            response.headers.get('content-type').includes('application/json')) {
          return response.json();
        } else {
          throw new Error('Response is not JSON');
        }
      })
      .then(data => {
        if (data.status === 'success') {
          updateCartCount(data.item_count);
        }
      })
      .catch(error => {
        console.error('è·å–è´­ç‰©è½¦æ•°é‡å¤±è´¥:', error);
      });
    }

    $(document).ready(function() {
      // é¡µé¢åŠ è½½å®Œæˆåï¼Œæ£€æŸ¥è´­ç‰©è½¦ä¸­çš„å•†å“å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
      checkCartItems();
      
      // è·å–è´­ç‰©è½¦å•†å“æ•°é‡
      getCartItemCount();

      // ä¸ºæ¯ä¸ª"åŠ å…¥è´­ç‰©è½¦"æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
      $('.main-content').on('click', '.add-to-cart-button', function() {
        const medicineId = $(this).data('medicine-id');
        const button = $(this);
        
        // å‘é€AJAXè¯·æ±‚å°†å•†å“æ·»åŠ åˆ°è´­ç‰©è½¦
        addToCart(medicineId).then(success => {
          if (success) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸º"å·²åœ¨è´­ç‰©è½¦"
            button.removeClass('add-to-cart-button').addClass('in-cart-button').text('å·²åœ¨è´­ç‰©è½¦').prop('disabled', true);
          } else {
            // å•†å“å·²åœ¨è´­ç‰©è½¦ä¸­
            button.removeClass('add-to-cart-button').addClass('in-cart-button').text('å·²åœ¨è´­ç‰©è½¦').prop('disabled', true);
          }
        });
      });
    });

    // æ£€æŸ¥è´­ç‰©è½¦ä¸­çš„å•†å“å¹¶æ›´æ–°æŒ‰é’®çŠ¶æ€
    function checkCartItems() {
      $.ajax({
        url: '/cart_info/',
        method: 'GET',
        success: function(response) {
          if (response.status === 'success') {
            const cartItems = response.items || [];
            cartItems.forEach(function(itemId) {
              $(`.add-to-cart-button[data-medicine-id="${itemId}"]`)
                .removeClass('add-to-cart-button')
                .addClass('in-cart-button')
                .text('å·²åœ¨è´­ç‰©è½¦')
                .prop('disabled', true);
            });
          }
        },
        error: function() {
          // å¦‚æœæ— æ³•è·å–è´­ç‰©è½¦ä¿¡æ¯ï¼Œåˆ™ä¿æŒåŸæ ·
        }
      });
    }
  </script>
  {% csrf_token %}
</body>

</html>