<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åŒ»é£é€Ÿè¾¾â€”â€”åœ¨çº¿æé—®</title>
<style>
/* -------------- é€šç”¨ -------------- */
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* -------------- é¡¶éƒ¨æ  -------------- */
.header {
  background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
  color: #fff;
  line-height: 50px;
  text-align: center;
  font-size: 18px;
  letter-spacing: 1px;
  position: relative;
  z-index: 10;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.header .back {
  position: absolute;
  left: 15px;
  top: 0;
  font-size: 20px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.3s;
}
.header .back:hover {
  background: rgba(255, 255, 255, 0.2);
}
.header .clear-history {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 14px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  border-radius: 15px;
  padding: 4px 12px;
  color: white;
  transition: background 0.3s;
}
.header .clear-history:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* -------------- æ¶ˆæ¯åŒº -------------- */
.chat-area {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 15px 12px 20px;
  background: url('/static/images/chat-bg.png') center/cover no-repeat, 
              linear-gradient(135deg, #f9fbfd 0%, #f0f4f9 100%);
}
.chat-area::-webkit-scrollbar { width: 6px; }
.chat-area::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); }
.chat-area::-webkit-scrollbar-thumb { 
  background: #c0c4cc; 
  border-radius: 3px;
}
.chat-area::-webkit-scrollbar-thumb:hover { background: #a0a4aa; }

/* æ—¶é—´çº¿ */
.time-split {
  text-align: center;
  font-size: 12px;
  color: #8492a6;
  margin: 15px 0;
  position: relative;
}
.time-split:before,
.time-split:after {
  content: "";
  position: absolute;
  top: 50%;
  width: 30%;
  height: 1px;
  background: #e0e6ed;
}
.time-split:before {
  left: 0;
}
.time-split:after {
  right: 0;
}

/* æ°”æ³¡ */
.msg {
  display: flex;
  align-items: flex-start;
  margin: 15px 0;
  animation: fadeIn .3s;
}
.msg.me { flex-direction: row-reverse; }
.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #ccc;
  object-fit: cover;
  flex-shrink: 0;
  align-self: flex-end;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}
.bubble {
  max-width: 70%;
  padding: 12px 15px;
  border-radius: 18px;
  font-size: 15px;
  line-height: 1.5;
  word-break: break-all;
  position: relative;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}
.msg.me .bubble {
  background: linear-gradient(120deg, #4fd09e 0%, #26d0ce 100%);
  color: white;
  margin-right: 12px;
  border-bottom-right-radius: 4px;
}
.msg.ai .bubble {
  background: #fff;
  color: #333;
  margin-left: 12px;
  border-bottom-left-radius: 4px;
}

/* å›¾ç‰‡æ¶ˆæ¯ */
.image-message {
  max-width: 200px;
  border-radius: 12px;
  margin: 5px 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

/* è¯å“æ¨è */
.medicine-recommendations {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px dashed #e0e6ed;
}

.medicine-recommendations h4 {
  margin: 0 0 12px 0;
  color: #1a2980;
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
}

.medicine-recommendations h4:before {
  content: "ğŸ’Š";
  margin-right: 8px;
}

.medicine-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
  gap: 12px;
}

.medicine-card {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 10px 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  text-align: center;
  cursor: pointer;
  border: 1px solid #ebeef5;
}
.msg.ai .medicine-card {
  background: rgba(255, 255, 255, 0.8);
}

.medicine-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #26d0ce;
}

.medicine-image {
  width: 100%;
  height: 60px;
  object-fit: contain;
  border-radius: 8px;
  background-color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: #8492a6;
  margin-bottom: 8px;
  border: 1px solid #ebeef5;
  overflow: hidden;
}

.medicine-image img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.medicine-name {
  font-size: 12px;
  font-weight: 500;
  margin: 3px 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #333;
}

/* Markdown æ ·å¼ */
.bubble h1, .bubble h2, .bubble h3 {
  margin: 12px 0 8px 0;
  font-weight: 600;
  color: #1a2980;
}
.bubble h1 {
  font-size: 1.4em;
  border-bottom: 1px solid #e0e6ed;
  padding-bottom: 6px;
}
.bubble h2 {
  font-size: 1.25em;
  border-bottom: 1px solid #e4e7ed;
  padding-bottom: 6px;
}
.bubble h3 {
  font-size: 1.1em;
}
.bubble p {
  margin: 0 0 10px 0;
}
.bubble ul, .bubble ol {
  margin: 10px 0;
  padding-left: 22px;
}
.bubble li {
  margin: 6px 0;
}
.bubble code {
  background-color: rgba(26, 41, 128, 0.08);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
  color: #1a2980;
}
.msg.me .bubble code {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}
.bubble pre {
  background-color: #f4f7fa;
  padding: 12px;
  border-radius: 8px;
  overflow-x: auto;
  margin: 12px 0;
  border: 1px solid #ebeef5;
}
.bubble pre code {
  background: none;
  padding: 0;
  color: #333;
}
.msg.me .bubble pre code {
  color: #333;
}
.bubble blockquote {
  border-left: 4px solid #26d0ce;
  margin: 12px 0;
  padding: 8px 15px;
  background: rgba(38, 208, 206, 0.05);
  border-radius: 0 8px 8px 0;
}
.msg.me .bubble blockquote {
  border-left-color: white;
  background: rgba(255, 255, 255, 0.15);
}
.bubble a {
  color: #1a2980;
  text-decoration: none;
  border-bottom: 1px dashed #1a2980;
}
.bubble a:hover {
  color: #26d0ce;
  border-bottom-style: solid;
}
.msg.me .bubble a {
  color: white;
  border-bottom: 1px dashed white;
}
.msg.me .bubble a:hover {
  border-bottom: 1px solid white;
}
.bubble strong {
  font-weight: 600;
}
.bubble em {
  font-style: italic;
}

/* -------------- åº•éƒ¨è¾“å…¥åŒº -------------- */
.input-bar {
  background: #fff;
  border-top: 1px solid #e0e6ed;
  display: flex;
  align-items: flex-end;
  padding: 10px 12px;
  flex-shrink: 0;
  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
}

.input-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #f5f7fa;
  border-radius: 20px;
  border: 1px solid #e0e6ed;
  margin-right: 10px;
}

#msgInput {
  border: none;
  border-radius: 20px;
  padding: 12px 15px;
  font-size: 15px;
  outline: none;
  resize: none;
  max-height: 120px;
  overflow-y: auto;
  background: transparent;
  min-height: 22px;
}
#msgInput:focus {
  border-color: #26d0ce;
}

.image-preview-container {
  display: flex;
  align-items: center;
  margin: 8px 10px 0;
  padding: 8px;
  background: #f0f4f9;
  border-radius: 12px;
  display: none;
}

.image-preview {
  max-height: 80px;
  max-width: 80px;
  border-radius: 8px;
  margin-right: 10px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  border: 1px solid #e0e6ed;
}

.remove-image {
  background: #e53935;
  color: white;
  border: none;
  border-radius: 50%;
  width: 22px;
  height: 22px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.button-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

#imageUpload {
  display: none;
}

.image-upload-label {
  background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
  color: white;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  box-shadow: 0 3px 8px rgba(26, 41, 128, 0.3);
  transition: transform 0.2s, box-shadow 0.2s;
}
.image-upload-label:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(26, 41, 128, 0.4);
}

#sendBtn {
  background: linear-gradient(135deg, #07c160 0%, #26d0ce 100%);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  font-size: 16px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 3px 8px rgba(7, 193, 96, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
}
#sendBtn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 10px rgba(7, 193, 96, 0.4);
}
#sendBtn:active {
  transform: scale(0.98);
}

/* åŠ è½½åŠ¨ç”» */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top: 3px solid #07c160;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
.msg.ai .loading {
  border: 3px solid rgba(0, 0, 0, 0.1);
  border-top: 3px solid #07c160;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* -------------- ç¡®è®¤å¯¹è¯æ¡† -------------- */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.3s;
}

.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 25px;
  border: none;
  border-radius: 12px;
  width: 80%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  animation: slideIn 0.3s;
}

@keyframes slideIn {
  from { transform: translateY(-50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-content h3 {
  margin-top: 0;
  color: #333;
  font-weight: 500;
}

.modal-buttons {
  margin-top: 25px;
  display: flex;
  justify-content: center;
  gap: 15px;
}

.modal-buttons button {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
  transition: all 0.2s;
}

.confirm-btn {
  background-color: #e53935;
  color: white;
  box-shadow: 0 3px 8px rgba(229, 57, 53, 0.3);
}
.confirm-btn:hover {
  background-color: #d32f2f;
  transform: translateY(-2px);
}

.cancel-btn {
  background-color: #f5f5f5;
  color: #666;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
}
.cancel-btn:hover {
  background-color: #e0e0e0;
  transform: translateY(-2px);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .bubble {
    max-width: 85%;
  }
  
  .medicine-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 10px;
  }
  
  .medicine-card {
    padding: 8px 6px;
  }
  
  .medicine-name {
    font-size: 11px;
  }
  
  .header {
    font-size: 17px;
  }
}

@media (max-width: 480px) {
  .chat-area {
    padding: 10px 8px 15px;
  }
  
  .bubble {
    padding: 10px 12px;
    font-size: 14px;
  }
  
  #msgInput {
    padding: 10px 12px;
    font-size: 14px;
  }
  
  .image-preview {
    max-height: 60px;
    max-width: 60px;
  }
  
  .modal-content {
    width: 90%;
    padding: 20px;
  }
}
</style>
</head>
<body>
{% include "ceil.html" %}
<div class="header">
  <span class="back" onclick="history.back()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 19L9 13L15 7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</span>
  åœ¨çº¿æé—®
  <button class="clear-history" id="clearHistoryBtn">æ¸…ç©ºè®°å½•</button>
</div>

<div class="chat-area" id="chatArea">
  <!-- åˆå§‹æ¬¢è¿è¯­ -->
  <div class="time-split" id="currentTime"></div>
  <div class="msg ai">
    <img class="avatar" src="/static/images/logo.jpg"/>
    <div class="bubble">ä½ å¥½ï¼Œæˆ‘æ˜¯åŒ»é£é€Ÿè¾¾æ™ºèƒ½åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ<br>æ‚¨å¯ä»¥ä¸Šä¼ å›¾ç‰‡è®©æˆ‘å¸®æ‚¨è¯†åˆ«å†…å®¹ã€‚</div>
  </div>
</div>

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h3>ç¡®è®¤æ¸…ç©ºè®°å½•</h3>
    <p>ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ</p>
    <div class="modal-buttons">
      <button class="confirm-btn" id="confirmClear">ç¡®å®š</button>
      <button class="cancel-btn" id="cancelClear">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<div class="input-bar">
  <div class="input-container">
    <textarea id="msgInput" placeholder="è¾“å…¥æ‚¨æƒ³è¯´çš„è¯..." rows="1"></textarea>
    <div class="image-preview-container" id="imagePreviewContainer">
      <img class="image-preview" id="imagePreview" src="" alt="Image preview">
      <button class="remove-image" id="removeImage">Ã—</button>
    </div>
  </div>
  <div class="button-group">
    <label for="imageUpload" class="image-upload-label">ğŸ“</label>
    <input type="file" id="imageUpload" accept="image/*">
    <button id="sendBtn">â¤</button>
  </div>
</div>

<script>
/* ---------- å·¥å…· ---------- */
const $ = q => document.querySelector(q);
const chatArea = $('#chatArea');
const input = $('#msgInput');
const imageUpload = $('#imageUpload');
const imagePreviewContainer = $('#imagePreviewContainer');
const imagePreview = $('#imagePreview');
const removeImage = $('#removeImage');

// è·å–ç”¨æˆ·å¤´åƒURLï¼ˆä»Djangoæ¨¡æ¿ä¼ é€’ï¼‰
const userAvatarUrl = '{% if user_avatar %}{{ user_avatar.url }}{% else %}https://cdn.jsdelivr.net/gh/lin09-assets/avatar/user.png{% endif %}';

// å­˜å‚¨é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶
let selectedImageFile = null;

/* æ»šåŠ¨åˆ°åº• */
function scrollBottom() {
  chatArea.scrollTop = chatArea.scrollHeight;
}

// æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆæ”¯æŒç›¸å¯¹æ—¶é—´ï¼‰
function formatTimeDisplay(date) {
    const now = new Date();
    const msgDate = new Date(date);

    // è®¡ç®—æ—¶é—´å·®ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
    const diffInHours = (now - msgDate) / (1000 * 60 * 60);

    if (diffInHours < 24) {
        return 'ä»Šå¤©';
    } else if (diffInHours < 48) {
        return 'æ˜¨å¤©';
    } else {
        const year = msgDate.getFullYear();
        const month = String(msgDate.getMonth() + 1).padStart(2, '0');
        const day = String(msgDate.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
}

// æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼ˆå…¨å±€ï¼‰
function updateTimeDisplay() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
}

// åˆ›å»ºæ—¶é—´åˆ†éš”çº¿ï¼ˆé¿å…é‡å¤ï¼‰
function createTimeSplit(date) {
    const timeDiv = document.createElement('div');
    timeDiv.className = 'time-split';
    timeDiv.textContent = formatTimeDisplay(date);
    return timeDiv;
}

/* ç®€å•çš„ Markdown è§£æå™¨ */
function parseMarkdown(text) {
  // è½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
  text = text.replace(/&/g, '&amp;')
             .replace(/</g, '&lt;')
             .replace(/>/g, '&gt;');

  // ä»£ç å— (```code```)
  text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

  // è¡Œå†…ä»£ç  (`code`)
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

  // ç²—ä½“ (**text** æˆ– __text__)
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');

  // æ–œä½“ (*text* æˆ– _text_)
  text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
  text = text.replace(/_(.*?)_/g, '<em>$1</em>');

  // é“¾æ¥ ([text](url))
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

  // å¼•ç”¨ (> text)
  text = text.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');

  // æ— åºåˆ—è¡¨ (* item æˆ– - item)
  text = text.replace(/^[\*\-] (.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>.+<\/li>\n?)+/g, '<ul>$&</ul>');
  text = text.replace(/<\/ul>\n?<ul>/g, '');

  // æœ‰åºåˆ—è¡¨ (1. item)
  text = text.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>.+<\/li>\n?)+/g, '<ol>$&</ol>');
  text = text.replace(/<\/ol>\n?<ol>/g, '');

  // æ ‡é¢˜ (# æ ‡é¢˜)
  text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
  text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
  text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
  text = text.replace(/^#### (.*$)/gm, '<h4>$1</h4>');

  // æ¢è¡Œç¬¦
  text = text.replace(/\n/g, '<br>'); 
  
  return text;
}

/* ç”Ÿæˆæ°”æ³¡ dom */
function createBubble(content, side = 'me', timestamp = new Date(), imageSrc = null, medicines = null) {
    // å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œå…ˆæ·»åŠ æ—¶é—´çº¿
    if (side === 'me' && chatArea.children.length === 2) { // åªæœ‰åˆå§‹æ¬¢è¿è¯­æ—¶
        chatArea.appendChild(createTimeSplit(timestamp));
    }
    
    const div = document.createElement('div');
    div.className = `msg ${side}`;
    
    // æ ¹æ®æ¶ˆæ¯æ¥æºé€‰æ‹©å¤´åƒ
    const avatarSrc = side === 'me' 
        ? userAvatarUrl 
        : '/static/images/logo.jpg';
    
    // åˆ›å»ºæ°”æ³¡å…ƒç´ ä½†æš‚æ—¶ä¸å¡«å……å†…å®¹
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    
    div.innerHTML = `<img class="avatar" src="${avatarSrc}"/>`;
    div.appendChild(bubble);
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ åˆ°æ°”æ³¡ä¸­
    if (imageSrc && side === 'me') {
        const img = document.createElement('img');
        img.className = 'image-message';
        img.src = imageSrc;
        bubble.appendChild(img);
        bubble.appendChild(document.createElement('br'));
    }
    
    chatArea.appendChild(div);
    scrollBottom();
    
    // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œåˆ™ä½¿ç”¨æµå¼è¾“å‡º
    if (side === 'ai') {
        streamText(bubble, content, medicines);
    } else {
        // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
        bubble.innerHTML += formatMessageContent(content);
        // ä¿å­˜æ¶ˆæ¯åˆ° sessionStorage
        saveMessageToHistory(content, side, timestamp, imageSrc, medicines);
    }
    
    return bubble; // è¿”å›æ°”æ³¡å…ƒç´ ä»¥ä¾¿åç»­æ“ä½œ
}

/* æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œä¿ç•™æ¢è¡Œç¬¦ */
function formatMessageContent(content) {
    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>æ ‡ç­¾
    return content.replace(/\n/g, '<br>');
}

/* æµå¼è¾“å‡ºæ–‡æœ¬ */
function streamText(element, text, medicines = null) {
    let i = 0;
    const speed = 20; // æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰
    let timestamp = new Date(); // è®°å½•å¼€å§‹æ—¶é—´
    
    function typeWriter() {
        if (i < text.length) {
            // å¤„ç†æ¢è¡Œç¬¦
            if (text.charAt(i) === '\n') {
                element.innerHTML += '<br>';
            } else {
                element.innerHTML += text.charAt(i);
            }
            i++;
            scrollBottom(); // æ¯æ¬¡æ·»åŠ å­—ç¬¦åæ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(typeWriter, speed);
        } else {
            // å®Œæˆåè§£æ Markdown å¹¶ä¿å­˜åˆ°å†å²è®°å½•
            element.innerHTML = parseMarkdown(text);
            
            // å¦‚æœæœ‰æ¨èè¯å“ï¼Œæ·»åŠ è¯å“æ¨èåŒºåŸŸ
            if (medicines && medicines.length > 0) {
                createMedicineRecommendations(element, medicines);
            }
            
            saveMessageToHistory(text, 'ai', timestamp, null, medicines);
        }
    }
    
    typeWriter();
}

/* åˆ›å»ºè¯å“æ¨èåŒºåŸŸ */
function createMedicineRecommendations(container, medicines) {
    const recDiv = document.createElement('div');
    recDiv.className = 'medicine-recommendations';
    recDiv.setAttribute('data-medicines', JSON.stringify(medicines)); // ä¿å­˜è¯å“æ•°æ®
    
    let medicineGridHtml = '';
    for (let i = 0; i < medicines.length; i++) {
        const med = medicines[i];
        medicineGridHtml += `
          <div class="medicine-card" onclick="viewMedicineDetail('${med.name}')">
            <div class="medicine-image">
              ${med.image ? `<img src="${med.image}" alt="${med.name}" onerror="this.parentElement.innerHTML='æš‚æ— å›¾ç‰‡'">` : 'æš‚æ— å›¾ç‰‡'}
            </div>
            <div class="medicine-name">${med.name}</div>
          </div>
        `;
    }
    
    recDiv.innerHTML = `
      <h4>æ™ºèƒ½æ¨èè¯å“ï¼š</h4>
      <div class="medicine-grid">
        ${medicineGridHtml}
      </div>
    `;
    
    container.appendChild(recDiv);
}

/* æŸ¥çœ‹è¯å“è¯¦æƒ…ï¼ˆå ä½å‡½æ•°ï¼‰ */
function viewMedicineDetail(medicineName) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ è·³è½¬åˆ°è¯å“è¯¦æƒ…é¡µçš„é€»è¾‘
    console.log('æŸ¥çœ‹è¯å“è¯¦æƒ…:', medicineName);
}
// åˆ¤æ–­æ˜¯å¦éœ€è¦æ’å…¥æ—¶é—´åˆ†éš”çº¿
function shouldInsertTimeSplit(lastMsgTime, currentMsgTime) {
    if (!lastMsgTime) return true; // ç¬¬ä¸€æ¡æ¶ˆæ¯æ€»æ˜¯æ’å…¥
    const last = new Date(lastMsgTime);
    const current = new Date(currentMsgTime);
    const diffInHours = (current - last) / (1000 * 60 * 60);
    return diffInHours >= 1; // è¶…è¿‡1å°æ—¶æ‰æ’å…¥åˆ†éš”çº¿
}
/* æ˜¾ç¤ºåŠ è½½çŠ¶æ€ */
function showLoading() {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'msg ai';
    loadingDiv.id = 'loadingMessage';
    loadingDiv.innerHTML = `
        <img class="avatar" src="/static/images/logo.jpg"/>
        <div class="bubble"><div class="loading"></div></div>`;
    chatArea.appendChild(loadingDiv);
    scrollBottom();
    return loadingDiv; // è¿”å›åŠ è½½å…ƒç´ ä»¥ä¾¿åç»­ç§»é™¤
}

/* éšè—åŠ è½½çŠ¶æ€ */
function hideLoading() {
  const loadingElement = document.getElementById('loadingMessage');
  if (loadingElement) {
    loadingElement.remove();
  }
}

/* å‘é€æ¶ˆæ¯åˆ°åç«¯ */
async function sendToBackend(message, imageFile = null) {
  try {
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    if (imageFile) {
      // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå‘é€åˆ° /execute_image_text/ æ¥å£
      formData.append('image', imageFile);
      if (message) {
        formData.append('text', message);
      }
      
      const response = await fetch('/execute_image_text/', {
        method: 'POST',
        body: formData
      });
      
      // æ£€æŸ¥å“åº”çŠ¶æ€
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // æ„é€ è¯å“æ•°æ®ç»“æ„
      const medicines = [];
      if (data.medicines && data.images) {
        for (let i = 0; i < data.medicines.length; i++) {
          medicines.push({
            name: data.medicines[i],
            image: data.images[i]
          });
        }
      }
      
      return {
        answer: data.answer || data.text || 'å›¾ç‰‡å¤„ç†å®Œæˆ',
        medicines: medicines
      };
    } else {
      // å¦‚æœåªæœ‰æ–‡æœ¬ï¼Œå‘é€åˆ°åŸæ¥çš„æ¥å£
      formData.append('question', message);
      
      const response = await fetch('', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      // æ£€æŸ¥å“åº”çŠ¶æ€
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      // æ„é€ è¯å“æ•°æ®ç»“æ„
      const medicines = [];
      if (data.medicines && data.images) {
        for (let i = 0; i < data.medicines.length; i++) {
          medicines.push({
            name: data.medicines[i],
            image: data.images[i]
          });
        }
      }
      
      return {
        answer: data.answer,
        medicines: medicines
      };
    }
  } catch (error) {
    console.error('Error:', error);
    if (error instanceof SyntaxError) {
      return {
        answer: 'æŠ±æ­‰ï¼ŒæœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”æ ¼å¼ã€‚è¯·ç¨åå†è¯•ã€‚',
        medicines: []
      };
    }
    return {
      answer: 'æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚',
      medicines: []
    };
  }
}

        /* ---------- å‘é€é€»è¾‘ ---------- */
        async function send() {
            const txt = input.value.trim();
            const imageFile = selectedImageFile;
            
            // å¿…é¡»æœ‰æ–‡æœ¬æˆ–å›¾ç‰‡æ‰èƒ½å‘é€
            if (!txt && !imageFile) return;
            
            let imageUrl = null;
            if (imageFile) {
                imageUrl = URL.createObjectURL(imageFile);
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯ï¼ˆåŒ…æ‹¬å›¾ç‰‡ï¼‰
            createBubble(txt, 'me', new Date(), imageUrl);
            input.value = '';
            selectedImageFile = null;
            imagePreviewContainer.style.display = 'none';
            autoTextareaHeight();
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const loadingElement = showLoading();
            
            // å‘é€åˆ°åç«¯å¹¶è·å–å›å¤
            const reply = await sendToBackend(txt, imageFile);
            
            // éšè—åŠ è½½çŠ¶æ€
            loadingElement.remove();
            
            // æ˜¾ç¤ºAIå›å¤ï¼ˆæµå¼è¾“å‡ºï¼‰
            createBubble(reply.answer, 'ai', new Date(), null, reply.medicines);
        } 

$('#sendBtn').onclick = send;
input.onkeydown = e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
};

// å¤„ç†å›¾ç‰‡ä¸Šä¼ 
imageUpload.onchange = function(e) {
  const file = e.target.files[0];
  if (file && file.type.startsWith('image/')) {
    selectedImageFile = file;
    const reader = new FileReader();
    reader.onload = function(e) {
      imagePreview.src = e.target.result;
      imagePreviewContainer.style.display = 'flex';
    };
    reader.readAsDataURL(file);
  }
};

// ç§»é™¤å›¾ç‰‡
removeImage.onclick = function() {
  selectedImageFile = null;
  imageUpload.value = '';
  imagePreviewContainer.style.display = 'none';
};

/* è¾“å…¥æ¡†é«˜åº¦è‡ªé€‚åº” */
function autoTextareaHeight() {
  input.style.height = 'auto';
  input.style.height = input.scrollHeight + 'px';
}
input.oninput = autoTextareaHeight;

/* ä¿å­˜æ¶ˆæ¯åˆ° sessionStorage */
function saveMessageToHistory(content, side, timestamp, imageSrc = null, medicines = null) {
  // è·å–ç°æœ‰çš„æ¶ˆæ¯å†å²
  let history = JSON.parse(sessionStorage.getItem('chatHistory') || '[]');
  
  // æ·»åŠ æ–°æ¶ˆæ¯
  history.push({
    content: content,
    side: side,
    timestamp: timestamp,
    imageSrc: imageSrc,
    medicines: medicines // ä¿å­˜è¯å“æ¨èä¿¡æ¯
  });
  
  // ä¿å­˜åˆ° sessionStorage
  sessionStorage.setItem('chatHistory', JSON.stringify(history));
}

/* ä» sessionStorage æ¢å¤èŠå¤©å†å² */
function restoreChatHistory() {
  const history = JSON.parse(sessionStorage.getItem('chatHistory') || '[]');
  
  // å¦‚æœæœ‰å†å²æ¶ˆæ¯ï¼Œåˆ™æ¸…é™¤é»˜è®¤çš„æ¬¢è¿è¯­ï¼ˆé™¤äº†æ—¶é—´çº¿ï¼‰
  if (history.length > 0) {
    // ä¿ç•™ç¬¬ä¸€ä¸ªæ—¶é—´çº¿ï¼Œç§»é™¤æ¬¢è¿è¯­
    while (chatArea.children.length > 1) {
      chatArea.removeChild(chatArea.lastChild);
    }
    
    // æ¢å¤å†å²æ¶ˆæ¯
    history.forEach(msg => {
      const timestamp = new Date(msg.timestamp);
      createBubbleFromHistory(msg.content, msg.side, timestamp, msg.imageSrc, msg.medicines);
    });
  }
}

/* ä»å†å²è®°å½•åˆ›å»ºæ°”æ³¡ï¼ˆä¸ä¿å­˜åˆ°å†å²è®°å½•ï¼‰ */
function createBubbleFromHistory(content, side, timestamp, imageSrc = null, medicines = null) {
    // å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œå…ˆæ·»åŠ æ—¶é—´çº¿
    if (side === 'me' && chatArea.children.length === 1) { // åªæœ‰æ—¶é—´çº¿æ—¶
        chatArea.appendChild(createTimeSplit(timestamp));
    }
    
    const div = document.createElement('div');
    div.className = `msg ${side}`;
    
    // æ ¹æ®æ¶ˆæ¯æ¥æºé€‰æ‹©å¤´åƒ
    const avatarSrc = side === 'me' 
        ? userAvatarUrl 
        : '/static/images/logo.jpg';
    
    // åˆ›å»ºæ°”æ³¡å…ƒç´ 
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    
    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ åˆ°æ°”æ³¡ä¸­
    if (imageSrc && side === 'me') {
        const img = document.createElement('img');
        img.className = 'image-message';
        img.src = imageSrc;
        bubble.appendChild(img);
        bubble.appendChild(document.createElement('br'));
    }
    
    // ç›´æ¥è®¾ç½®å†…å®¹ï¼ˆå†å²è®°å½•ä¸éœ€è¦æµå¼è¾“å‡ºï¼‰
    if (side === 'ai') {
        // AIæ¶ˆæ¯éœ€è¦è§£æMarkdown
        bubble.innerHTML += parseMarkdown(content);
        // å¦‚æœæœ‰è¯å“æ¨èä¿¡æ¯ï¼Œæ·»åŠ è¯å“æ¨èåŒºåŸŸ
        if (medicines && medicines.length > 0) {
            createMedicineRecommendations(bubble, medicines);
        }
    } else {
        // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤º
        bubble.innerHTML += formatMessageContent(content);
    }
    
    div.innerHTML = `<img class="avatar" src="${avatarSrc}"/>`;
    div.appendChild(bubble);
    
    chatArea.appendChild(div);
    scrollBottom();
}

/* æ¸…é™¤èŠå¤©å†å² */
function clearChatHistory() {
  sessionStorage.removeItem('chatHistory');
  // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºåˆå§‹çŠ¶æ€
  location.reload();
}

/* é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°æ—¶é—´ */
document.addEventListener('DOMContentLoaded', function() {
  updateTimeDisplay();
  
  // ååˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
  setInterval(updateTimeDisplay, 600000);

  // æ¢å¤èŠå¤©å†å²
  restoreChatHistory();
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„è¯·æ±‚
  setTimeout(checkPendingRequests, 500);
  
  // ç»‘å®šæ¸…ç©ºå†å²è®°å½•æŒ‰é’®äº‹ä»¶
  document.getElementById('clearHistoryBtn').addEventListener('click', function() {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    document.getElementById('confirmModal').style.display = 'block';
  });
  
  // ç»‘å®šç¡®è®¤æ¸…ç©ºæŒ‰é’®äº‹ä»¶
  document.getElementById('confirmClear').addEventListener('click', function() {
    clearChatHistory();
    // éšè—ç¡®è®¤å¯¹è¯æ¡†
    document.getElementById('confirmModal').style.display = 'none';
  });
  
  // ç»‘å®šå–æ¶ˆæ¸…ç©ºæŒ‰é’®äº‹ä»¶
  document.getElementById('cancelClear').addEventListener('click', function() {
    // éšè—ç¡®è®¤å¯¹è¯æ¡†
    document.getElementById('confirmModal').style.display = 'none';
  });
});

// ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œå½“é¡µé¢å˜ä¸ºå¯è§æ—¶æ¢å¤èŠå¤©å†å²
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    restoreChatHistory();
  }
});

// ç›‘å¬é¡µé¢æ˜¾ç¤ºäº‹ä»¶ï¼ˆå½“ç”¨æˆ·ä»å…¶ä»–é¡µé¢è¿”å›æ—¶è§¦å‘ï¼‰
window.addEventListener('pageshow', function(event) {
  // å¦‚æœæ˜¯ä»ç¼“å­˜ä¸­åŠ è½½çš„é¡µé¢ï¼Œåˆ™æ¢å¤èŠå¤©å†å²
  if (event.persisted) {
    restoreChatHistory();
  }
});

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
window.onclick = function(event) {
  const modal = document.getElementById('confirmModal');
  if (event.target == modal) {
    modal.style.display = 'none';
  }
}
// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸï¼ˆå·²ä¿®æ”¹ï¼‰
function addMessage(content, side, date, imageSrc = null, medicines = []) {
    const chatArea = document.getElementById('chatArea');
    const div = document.createElement('div');
    div.className = `msg ${side}`;

    // è®¾ç½®æ—¶é—´
    const timeDiv = document.createElement('div');
    timeDiv.className = 'message-time';
    timeDiv.textContent = formatTimeDisplay(date);
    div.appendChild(timeDiv);

    // å¤„ç†å¤´åƒå’Œæ°”æ³¡
    const avatarSrc = side === 'me' 
        ? userAvatarUrl 
        : '/static/images/logo.jpg';

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    // å›¾ç‰‡å¤„ç†
    if (imageSrc && side === 'me') {
        const img = document.createElement('img');
        img.className = 'image-message';
        img.src = imageSrc;
        bubble.appendChild(img);
        bubble.appendChild(document.createElement('br'));
    }

    // å†…å®¹å¤„ç†
    if (side === 'ai') {
        bubble.innerHTML += parseMarkdown(content);
        if (medicines && medicines.length > 0) {
            createMedicineRecommendations(bubble, medicines);
        }
    } else {
        bubble.innerHTML += formatMessageContent(content);
    }

    div.innerHTML = `<img class="avatar" src="${avatarSrc}"/>`;
    div.appendChild(bubble);
    chatArea.appendChild(div);

    // æ’å…¥æ—¶é—´åˆ†éš”çº¿ï¼ˆå¦‚æœéœ€è¦ï¼‰
    const lastMsg = chatArea.lastElementChild;
    if (lastMsg && lastMsg.classList.contains('msg')) {
        const lastMsgTime = lastMsg.querySelector('.message-time').textContent;
        if (shouldInsertTimeSplit(lastMsgTime, formatTimeDisplay(date))) {
            const timeSplit = createTimeSplit(date);
            chatArea.appendChild(timeSplit);
        }
    }

    scrollBottom();
}
/* æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„è¯·æ±‚ */
function checkPendingRequests() {
    // æ£€æŸ¥æ˜¯å¦æœ‰åŠ è½½çŠ¶æ€çš„æ¶ˆæ¯
    const loadingElement = document.getElementById('loadingMessage');
    if (loadingElement) {
        // å¦‚æœæœ‰åŠ è½½çŠ¶æ€ï¼Œé‡æ–°å‘é€è¯·æ±‚
        // è¿™é‡Œéœ€è¦ä» sessionStorage ä¸­è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
        const history = JSON.parse(sessionStorage.getItem('chatHistory') || '[]');
        if (history.length > 0) {
            // æ‰¾åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
            let lastUserMessage = null;
            for (let i = history.length - 1; i >= 0; i--) {
                if (history[i].side === 'me') {
                    lastUserMessage = history[i];
                    break;
                }
            }
            
            if (lastUserMessage) {
                // é‡æ–°å‘é€è¯·æ±‚
                resendPendingRequest(lastUserMessage);
            }
        }
    }
}

/* é‡æ–°å‘é€æœªå®Œæˆçš„è¯·æ±‚ */
async function resendPendingRequest(userMessage) {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading();
    
    try {
        // é‡æ–°å‘é€è¯·æ±‚
        const reply = await sendToBackend(userMessage.content, userMessage.imageSrc ? new File([], 'image') : null);
        
        // éšè—åŠ è½½çŠ¶æ€
        hideLoading();
        
        // æ˜¾ç¤ºAIå›å¤ï¼ˆæµå¼è¾“å‡ºï¼‰
        createBubble(reply.answer, 'ai', new Date(), null, reply.medicines);
    } catch (error) {
        // éšè—åŠ è½½çŠ¶æ€
        hideLoading();
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        createBubble('æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai', new Date(), null, []);
    }
}
</script>
<!-- CSRF Token -->
{% csrf_token %}
</body>
</html>