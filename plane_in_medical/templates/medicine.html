<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é£é€Ÿè¾¾â€”â€”ç‰©èµ„ä¸‹å•</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
               background: #f7f9fc; color: #333; line-height: 1.5; }

        .medicine-container { max-width: 1240px; margin: 0 auto; padding: 20px 10px; }
        .medicine-grid { display: grid; gap: 20px; }
        @media (min-width: 1025px) { .medicine-grid { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 1024px) and (min-width: 600px) { .medicine-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 599px) { .medicine-grid { grid-template-columns: 1fr; } }

        .medicine-card { background: #fff; border-radius: 12px;
                         box-shadow: 0 2px 6px rgba(0,0,0,.06);
                         display: flex; flex-direction: column; height: 100%;
                         transition: transform .25s, box-shadow .25s; position: relative; }
        .medicine-card:hover { transform: translateY(-4px); box-shadow: 0 6px 18px rgba(0,0,0,.10); }

        .medicine-image { width: 100%; aspect-ratio: 4 / 3;
                          object-fit: cover; border-radius: 12px 12px 0 0; }
        .medicine-body  { padding: 14px 16px 18px; flex: 1; display: flex; flex-direction: column; }

        .medicine-name  { font-size: 17px; font-weight: 600; margin-bottom: 6px; }
        .medicine-kind  { font-size: 13px; color: #888; margin-bottom: 10px; }
        .medicine-intro { font-size: 14px; color: #555; flex: 1;
                          display: -webkit-box; -webkit-line-clamp: 3;
                          -webkit-box-orient: vertical; overflow: hidden; }
        .medicine-price { margin-top: 12px; font-size: 22px; color: #ff4757; font-weight: 700; }

        .action-buttons {
            display: none;
            position: absolute;
            bottom: 12px;
            width: 100%;
            padding: 0 12px;
            justify-content: space-between;
        }
        .medicine-card:hover .action-buttons {
            display: flex;
        }
        .add-cart-btn {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .add-cart-btn.remove {
            background: #dc3545;
        }
        .view-detail-btn {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            text-decoration: none;
        }

        .pagination-wrapper { margin-top: 40px; display: flex; justify-content: center; }
        .pagination { display: flex; align-items: center; gap: 8px; user-select: none; }
        .pagination a, .pagination span {
            min-width: 38px; height: 38px; display: inline-flex; align-items: center;
            justify-content: center; border-radius: 8px; font-size: 14px;
            border: 1px solid #e6e6e6; background: #fff; color: #333;
            text-decoration: none; transition: .2s; }
        .pagination a:hover { background: #f2f2f2; }
        .pagination .current { background: #007bff; color: #fff; border-color: #007bff; }
        .pagination .disabled { color: #ccc; cursor: not-allowed; }

        .cart-entry {
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 54px;
            height: 54px;
            background: #007bff;
            border-radius: 50%;
            text-align: center;
            line-height: 54px;
            font-size: 22px;
            box-shadow: 0 2px 8px rgba(0,0,0,.25);
            cursor: pointer;
            z-index: 999;
        }
        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background: #ff4757;
            color: #fff;
            font-size: 12px;
            min-width: 18px;
            height: 18px;
            line-height: 18px;
            border-radius: 9px;
            padding: 0 4px;
        }
        .cart-tip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,.7);
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            display: none;
            z-index: 9999;
        }
        .medicine-card {
            position: relative;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            grid-column: 1 / -1;
        }
        .cart-entry {
            transition: transform 0.2s;
        }
        .cart-entry:hover {
            transform: scale(1.1);
        }
        @media (max-width: 599px) {
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }
            .add-cart-btn, .view-detail-btn {
                width: 100%;
                text-align: center;
            }
        }
        
        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ–°å¢ç­›é€‰åŠŸèƒ½æ ·å¼ */
        .filter-section {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,.06);
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        

        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }
        
        .filter-select, .filter-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            transition: border-color 0.2s;
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .filter-buttons {
            display: flex;
            justify-content: center; /* å±…ä¸­æ˜¾ç¤ºæŒ‰é’® */
            gap: 10px;
            margin-top: 10px;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .apply-btn {
            background: #007bff;
            color: #fff;
        }
        
        .apply-btn:hover {
            background: #0069d9;
        }
        
        .reset-btn {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .reset-btn:hover {
            background: #e9ecef;
        }
        
        .price-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .price-range .filter-input {
            flex: 1;
        }
        
        .price-separator {
            font-size: 14px;
            color: #777;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .price-range {
                flex-direction: column;
                align-items: stretch;
            }
            
            .price-separator {
                text-align: center;
                padding: 5px 0;
            }
        }
    </style>
</head>
<body>
    {% include "ceil.html" %}
    <div class="medicine-container">
        <!-- æ–°å¢ç­›é€‰éƒ¨åˆ† -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label" for="kind-filter">è¯å“ç§ç±»</label>
                    <select class="filter-select" id="kind-filter">
                        <option value="">å…¨éƒ¨ç§ç±»</option>
                        <option value="ä¸­è¯">ä¸­è¯</option>
                        <option value="è¥¿è¯">è¥¿è¯</option>
                        <option value="ä¿å¥å“">ä¿å¥å“</option>
                        <option value="é˜²ç–«ç”¨å“">é˜²ç–«ç”¨å“</option>
                        <option value="åŒ»ç–—å™¨æ¢°">åŒ»ç–—å™¨æ¢°</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="price-filter">ä»·æ ¼èŒƒå›´</label>
                    <div class="price-range">
                        <input type="number" class="filter-input" id="min-price" placeholder="æœ€ä½ä»·" min="0" step="0.01">
                        <span class="price-separator">-</span>
                        <input type="number" class="filter-input" id="max-price" placeholder="æœ€é«˜ä»·" min="0" step="0.01">
                    </div>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="sort-filter">æ’åºæ–¹å¼</label>
                    <select class="filter-select" id="sort-filter">
                        <option value="default">é»˜è®¤æ’åº</option>
                        <option value="price-asc">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                        <option value="price-desc">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                        <option value="name-asc">åç§° A-Z</option>
                        <option value="name-desc">åç§° Z-A</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn apply-btn" id="apply-filter">åº”ç”¨ç­›é€‰</button>
                <button class="filter-btn reset-btn" id="reset-filter">é‡ç½®ç­›é€‰</button>
            </div>
        </div>
        
        <div class="medicine-grid" id="medicineGrid">
            {% for m in medicine_data.object_list %}
            <div class="medicine-card" data-id="{{ m.id }}">
                {% if m.image %}
                <img src="{{ m.image }}" alt="{{ m.name }} è¯å“å›¾ç‰‡" class="medicine-image">
                {% else %}
                <div class="medicine-image placeholder">æš‚æ— å›¾ç‰‡</div>
                {% endif %}
                <div class="medicine-body">
                    <div class="medicine-name">{{ m.name }}</div>
                    <div class="medicine-kind">{{ m.kind }}</div>
                    <div class="medicine-intro">{{ m.introduction|default:"æš‚æ— ç®€ä»‹" }}</div>
                    <div class="medicine-price">Â¥{{ m.price|floatformat:2 }}</div>
                </div>
                <div class="action-buttons">
                    <button class="add-cart-btn" aria-label="æ·»åŠ  {{ m.name }} åˆ°è´­ç‰©è½¦">åŠ å…¥è´­ç‰©è½¦</button>
                    <a href="/medicine/{{ m.id }}/inscription/" class="view-detail-btn" aria-label="æŸ¥çœ‹ {{ m.name }} è¯¦æƒ…">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
            {% empty %}
            <p style="text-align:center;color:#999;grid-column:1/-1;">æš‚æ— è¯å“æ•°æ®</p>
            {% endfor %}
            <div class="loading" id="loadingIndicator">
                åŠ è½½ä¸­...
            </div>
        </div>
        
        <div class="pagination-wrapper">
            <nav class="pagination">
                {% if medicine_data.has_previous %}
                    <a href="/medicine/1/">é¦–é¡µ</a>
                    <a href="/medicine/{{ medicine_data.previous_page_number }}/">ä¸Šä¸€é¡µ</a>
                {% else %}
                    <span class="disabled">é¦–é¡µ</span>
                    <span class="disabled">ä¸Šä¸€é¡µ</span>
                {% endif %}
 
                <span class="current">
                    ç¬¬ {{ medicine_data.number }} é¡µ / å…± {{ medicine_data.paginator.num_pages }} é¡µ
                </span>
 
                {% if medicine_data.has_next %}
                    <a href="/medicine/{{ medicine_data.next_page_number }}/">ä¸‹ä¸€é¡µ</a>
                    <a href="/medicine/{{ medicine_data.paginator.num_pages }}/">å°¾é¡µ</a>
                {% else %}
                    <span class="disabled">ä¸‹ä¸€é¡µ</span>
                    <span class="disabled">å°¾é¡µ</span>
                {% endif %}
            </nav>
        </div>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>
 
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ä¿®æ”¹åˆ†é¡µé“¾æ¥ï¼Œä¿ç•™ç­›é€‰å‚æ•°
    const paginationLinks = document.querySelectorAll('.pagination a');
    const urlParams = new URLSearchParams(window.location.search);
    
    // æ„å»ºç­›é€‰å‚æ•°å­—ç¬¦ä¸²
    const filterParams = [];
    if (urlParams.get('kind')) filterParams.push(`kind=${urlParams.get('kind')}`);
    if (urlParams.get('min_price')) filterParams.push(`min_price=${urlParams.get('min_price')}`);
    if (urlParams.get('max_price')) filterParams.push(`max_price=${urlParams.get('max_price')}`);
    if (urlParams.get('sort_by')) filterParams.push(`sort_by=${urlParams.get('sort_by')}`);
    
    const filterParamString = filterParams.length > 0 ? '&' + filterParams.join('&') : '';
    
    // æ›´æ–°æ‰€æœ‰åˆ†é¡µé“¾æ¥
    paginationLinks.forEach(link => {
        if (link.href && !link.href.includes('?')) {
            link.href += '?' + filterParamString.substring(1);
        } else if (filterParamString) {
            link.href += filterParamString;
        }
    });

    // åº”ç”¨ç­›é€‰æŒ‰é’®äº‹ä»¶
    document.getElementById('apply-filter').addEventListener('click', function() {
        applyFilter();
    });
    
    // é‡ç½®ç­›é€‰æŒ‰é’®äº‹ä»¶
    document.getElementById('reset-filter').addEventListener('click', function() {
        resetFilter();
    });
    
    // åº”ç”¨ç­›é€‰å‡½æ•°
    function applyFilter() {
        const kind = document.getElementById('kind-filter').value;
        const minPrice = document.getElementById('min-price').value;
        const maxPrice = document.getElementById('max-price').value;
        const sortBy = document.getElementById('sort-filter').value;
        
        let url = new URL(window.location);
        url.searchParams.set('page', 1); // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
        
        if (kind) {
            url.searchParams.set('kind', kind);
        } else {
            url.searchParams.delete('kind');
        }
        
        if (minPrice) {
            url.searchParams.set('min_price', minPrice);
        } else {
            url.searchParams.delete('min_price');
        }
        
        if (maxPrice) {
            url.searchParams.set('max_price', maxPrice);
        } else {
            url.searchParams.delete('max_price');
        }
        
        if (sortBy && sortBy !== 'default') {
            url.searchParams.set('sort_by', sortBy);
        } else {
            url.searchParams.delete('sort_by');
        }
        
        window.location.href = url.toString();
    }
    
    // é‡ç½®ç­›é€‰å‡½æ•° - ä¿®æ”¹ä¸ºç›´æ¥è·³è½¬åˆ° /medicine/
    function resetFilter() {
        document.getElementById('kind-filter').value = '';
        document.getElementById('min-price').value = '';
        document.getElementById('max-price').value = '';
        document.getElementById('sort-filter').value = 'default';
        
        // ç›´æ¥è·³è½¬åˆ°åŸºç¡€è·¯å¾„ï¼Œæ¸…é™¤æ‰€æœ‰ç­›é€‰å‚æ•°
        window.location.href = '/medicine/';
    }
    
    // é¡µé¢åŠ è½½æ—¶è®¾ç½®ç­›é€‰è¡¨å•çš„å€¼
    const urlParams2 = new URLSearchParams(window.location.search);
    const kindFilter = urlParams2.get('kind');
    const minPriceFilter = urlParams2.get('min_price');
    const maxPriceFilter = urlParams2.get('max_price');
    const sortByFilter = urlParams2.get('sort_by');
    
    if (kindFilter) {
        document.getElementById('kind-filter').value = kindFilter;
    }
    
    if (minPriceFilter) {
        document.getElementById('min-price').value = minPriceFilter;
    }
    
    if (maxPriceFilter) {
        document.getElementById('max-price').value = maxPriceFilter;
    }
    
    if (sortByFilter) {
        document.getElementById('sort-filter').value = sortByFilter;
    }
});

// è´­ç‰©è½¦ç›¸å…³åŠŸèƒ½
(function() {
    // CSRF token helper
    function getCSRFToken() {
        return $('input[name=csrfmiddlewaretoken]').val();
    }
    
    // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    function showLoading() {
        $('#loadingOverlay').css('display', 'flex');
    }
    
    // éšè—åŠ è½½æŒ‡ç¤ºå™¨
    function hideLoading() {
        $('#loadingOverlay').hide();
    }
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showTip(text) {
        const $tip = $(`<div class="cart-tip">${text}</div>`);
        $('body').append($tip);
        $tip.fadeIn(200).delay(1200).fadeOut(400, () => $tip.remove());
    }
    
    // æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
    function addToCart(medicineId, quantity = 1) {
        showLoading();
        
        return fetch('/add_to_cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                medicine_id: medicineId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                showTip('å•†å“æˆåŠŸåŠ å…¥è´­ç‰©è½¦ï¼');
                updateCartCount(data.item_count);
                return true;
            } else {
                showTip('æ·»åŠ å¤±è´¥: ' + data.message);
                return false;
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showTip('æ·»åŠ å¤±è´¥');
            return false;
        });
    }
    
    // ä»è´­ç‰©è½¦ç§»é™¤å•†å“
    function removeFromCart(medicineId) {
        showLoading();
        
        return fetch('/remove_from_cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({
                medicine_id: medicineId
            })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.status === 'success') {
                showTip('å·²ä»è´­ç‰©è½¦ç§»é™¤');
                updateCartCount(data.item_count);
                return true;
            } else {
                showTip('ç§»é™¤å¤±è´¥: ' + data.message);
                return false;
            }
        })
        .catch(error => {
            hideLoading();
            console.error('Error:', error);
            showTip('ç§»é™¤å¤±è´¥');
            return false;
        });
    }
    
    // æ›´æ–°è´­ç‰©è½¦è®¡æ•°
    function updateCartCount(count) {
        $('.cart-count').text(count);
    }
    
    // è·å–è´­ç‰©è½¦å•†å“æ•°é‡
    function getCartItemCount() {
        fetch('/cart_info/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.headers.get('content-type') && 
                response.headers.get('content-type').includes('application/json')) {
                return response.json();
            } else {
                throw new Error('Response is not JSON');
            }
        })
        .then(data => {
            if (data.status === 'success') {
                updateCartCount(data.item_count);
            }
        })
        .catch(error => {
            console.error('è·å–è´­ç‰©è½¦æ•°é‡å¤±è´¥:', error);
        });
    }
    
    // åˆå§‹åŒ–è´­ç‰©è½¦å…¥å£
    function initCartEntry() {
        const $entry = $(`<div class="cart-entry">
                            <span class="cart-count">0</span>
                            <a href="/cart_view/" aria-label="æŸ¥çœ‹è´­ç‰©è½¦">ğŸ›’</a>
                          </div>`);
        $('body').append($entry);
    }
    
    // åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    function initButtonStates() {
        // é»˜è®¤æ‰€æœ‰æŒ‰é’®æ˜¾ç¤º"åŠ å…¥è´­ç‰©è½¦"
    }
    
    // åˆå§‹åŒ–
    $(function() {
        initCartEntry();
        initButtonStates();
        
        // è·å–è´­ç‰©è½¦å•†å“æ•°é‡
        getCartItemCount();
        
        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€ç”Ÿæˆçš„æŒ‰é’®
        $('#medicineGrid').on('click', '.add-cart-btn', function(e) {
            e.stopPropagation();
            const $button = $(this);
            const $card = $button.closest('.medicine-card');
            const id = $card.data('id');
            
            if ($button.hasClass('remove')) {
                // ä»è´­ç‰©è½¦ç§»é™¤å•†å“
                removeFromCart(id).then(success => {
                    if (success) {
                        $button.text('åŠ å…¥è´­ç‰©è½¦').removeClass('remove');
                        $button.attr('aria-label', 'æ·»åŠ åˆ°è´­ç‰©è½¦');
                    }
                });
            } else {
                // æ·»åŠ åˆ°è´­ç‰©è½¦
                addToCart(id).then(success => {
                    if (success) {
                        $button.text('å–æ¶ˆæ”¾å…¥').addClass('remove');
                        $button.attr('aria-label', 'ä»è´­ç‰©è½¦ç§»é™¤');
                    }
                });
            }
        });
    });
})();
</script>
    {% csrf_token %}
    {% include 'footer.html' %}
</body>
</html>