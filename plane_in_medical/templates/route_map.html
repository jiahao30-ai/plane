<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»é£é€Ÿè¾¾ - è¥¿å®‰å¸‚æ™ºèƒ½è·¯å¾„è§„åˆ’</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .map-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 80px);
            margin-top: 80px;
        }

        #container {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            position: absolute;
            right: 20px;
            top: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-panel h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-panel h3::before {
            content: "ğŸ—ºï¸";
            font-size: 20px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .search-input:focus {
            outline: none;
            border-color: #17a2b8;
            box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
            background: white;
        }

        .search-btn {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .search-btn:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .location-section {
            margin-top: 20px;
        }

        .location-section h4 {
            color: #495057;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .location-section h4::before {
            content: "ğŸ“";
            font-size: 16px;
        }

        .location-btn {
            display: block;
            margin: 8px 0;
            padding: 12px 15px;
            background: rgba(248, 249, 250, 0.8);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #495057;
            position: relative;
            overflow: hidden;
        }

        .location-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .location-btn:hover {
            background: rgba(23, 162, 184, 0.1);
            border-color: #17a2b8;
            transform: translateX(5px);
            color: #17a2b8;
        }

        .location-btn:hover::before {
            left: 100%;
        }

        .location-btn.active {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border-color: #17a2b8;
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }

        .separator {
            height: 2px;
            background: linear-gradient(90deg, transparent, #e1e8ed, transparent);
            margin: 20px 0;
            border-radius: 1px;
        }

        .map-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .map-info h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .map-info p {
            color: #6c757d;
            font-size: 12px;
            margin: 2px 0;
        }

        /* åŒ»é™¢é€‰æ‹©ç†ç”±æ ·å¼ */
        .selection-reasons {
            position: absolute;
            top: 90px; /* åœ¨å¯¼èˆªæ ä¸‹æ–¹ (å¯¼èˆªæ é«˜åº¦70px + 20pxé—´è·) */
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .selection-reasons h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selection-reasons h3::before {
            content: "ğŸ’¡";
            font-size: 20px;
        }

        .selection-reasons ul {
            padding-left: 20px;
            margin: 15px 0;
        }

        .selection-reasons li {
            margin-bottom: 10px;
            color: #495057;
            font-size: 14px;
        }

        .selection-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
        }

        .selection-details p {
            margin: 5px 0;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        /* åŒ»é™¢å›¾ä¾‹ */
        .hospital-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .hospital-legend h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 13px;
            font-weight: 600;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        /* é£è¡Œæ¨¡æ‹Ÿæ§åˆ¶ */
        .flight-control {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .flight-control h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .flight-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .flight-btn:hover {
            background: linear-gradient(135deg, #218838, #1ba87e);
            transform: translateY(-2px);
        }

        .flight-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .control-panel {
                width: 280px;
                right: 15px;
                top: 15px;
            }
        }

        @media (max-width: 768px) {
            .map-container {
                height: calc(100vh - 60px);
                margin-top: 60px;
            }

            .control-panel {
                position: fixed;
                top: 10px;
                right: 10px;
                left: 10px;
                width: auto;
                padding: 20px;
                border-radius: 10px;
            }

            .map-info {
                bottom: 10px;
                left: 10px;
                right: 10px;
                padding: 12px 15px;
            }

            #container {
                border-radius: 10px;
            }
        }

        @media (max-width: 480px) {
            .control-panel {
                padding: 15px;
            }

            .control-panel h3 {
                font-size: 16px;
            }

            .search-input, .search-btn, .location-btn {
                padding: 10px 12px;
                font-size: 13px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #17a2b8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .control-panel::-webkit-scrollbar {
            width: 6px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: #17a2b8;
            border-radius: 3px;
        }

        .control-panel::-webkit-scrollbar-thumb:hover {
            background: #138496;
        }

        /* æœåŠ¡èŒƒå›´é™åˆ¶å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease;
            text-align: center;
        }

        .modal-overlay.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-icon {
            font-size: 60px;
            color: #ffc107;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .modal-message {
            font-size: 16px;
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .modal-location {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }
        .content-wrapper { 
            margin-top: 70px;
        }
        .modal-location strong {
            color: #495057;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .service-features {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }

        .service-features h4 {
            color: #17a2b8;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .service-features ul {
            list-style: none;
            padding: 0;
        }

        .service-features li {
            padding: 5px 0;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .service-features li::before {
            content: "âœ“";
            color: #28a745;
            font-weight: bold;
        }

        /* åŒ»é™¢æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .hospital-control {
            margin: 15px 0;
        }

        .hospital-toggle-btn {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(135deg, #FF4757, #FF6B35);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .hospital-toggle-btn:hover {
            background: linear-gradient(135deg, #FF3742, #FF5722);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .hospital-toggle-btn.active {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .hospital-toggle-btn.active:hover {
            background: linear-gradient(135deg, #00a085, #00b7b3);
        }

        /* é€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            min-width: 300px;
            text-align: center;
        }

        .notification.info {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
        }

        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .notification.error {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
        }
    </style>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=e5QIM8cxaWeB2idV44dTEW3lVw3xGKgK"></script>
</head>

<body>
    {% include "ceil.html" %}

    <div class="map-container">
        <div id="container"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <script>               
        // å…¨å±€å˜é‡
        var map;
        var startMarker;
        var endMarker;
        var loading = document.getElementById('loading');
        var routePolyline = null; // è·¯å¾„çº¿
        var flightMarker = null; // é£è¡Œå™¨æ ‡è®°
        var animationInterval = null;
        var currentPointIndex = 0;
        var totalPoints = 0;
        var pointsArray = [];
        var currentFlightPosition = null; // ä¿å­˜å½“å‰é£è¡Œå™¨ä½ç½®
        var isAnimationRunning = false;   // æ ‡è®°åŠ¨ç”»æ˜¯å¦æ­£åœ¨è¿è¡Œ
        // èµ·å§‹ç‚¹å°†ä»åç«¯ä¼ é€’çš„æœ€è¿‘åŒ»é™¢è·å–
        var startPoint;
        var hospitalMarkers = []; // å­˜å‚¨åŒ»é™¢æ ‡è®°

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            showLoading();

            // åˆ›å»ºåœ°å›¾å®ä¾‹
            map = new BMap.Map("container");

            // åœ°å›¾åˆå§‹åŒ–ï¼Œè®¾ç½®åˆ°è¥¿å®‰å¸‚ä¸­å¿ƒ
            map.centerAndZoom(new BMap.Point(108.948, 34.263), 12);

            // å¯ç”¨åŠŸèƒ½
            map.enableScrollWheelZoom(true);

            // æ·»åŠ åœ°å›¾æ§ä»¶
            map.addControl(new BMap.NavigationControl({
                anchor: BMAP_ANCHOR_TOP_LEFT,
                type: BMAP_NAVIGATION_CONTROL_LARGE
            }));

            map.addControl(new BMap.ScaleControl({
                anchor: BMAP_ANCHOR_BOTTOM_LEFT
            }));

            // è®¾ç½®èµ·å§‹ç‚¹ä¸ºæœ€è¿‘çš„åŒ»é™¢
            setStartPoint();

            // æ·»åŠ èµ·ç‚¹æ ‡è®°
            addStartMarker();

            // æ·»åŠ åŒ»é™¢èŠ‚ç‚¹
            addHospitalMarkers();

            // éšè—åŠ è½½åŠ¨ç”»
            hideLoading();

            // å¤„ç†URLå‚æ•°
            processUrlParameters();

            // æ˜¾ç¤ºåŒ»é™¢é€‰æ‹©ç†ç”±
            showSelectionReasons();
        }

        // è®¾ç½®èµ·å§‹ç‚¹ä¸ºæœ€è¿‘çš„åŒ»é™¢
        function setStartPoint() {
            // ä»åç«¯è·å–æœ€è¿‘çš„åŒ»é™¢ä¿¡æ¯
            var nearestHospital = null;
            try {
                // å°è¯•è§£ææœ€è¿‘åŒ»é™¢æ•°æ®
                var nearestHospitalData = '{{ nearest_hospital|escapejs }}';
                console.log("æœ€è¿‘åŒ»é™¢æ•°æ®:", nearestHospitalData);
                if (nearestHospitalData && nearestHospitalData !== 'null' && nearestHospitalData !== '') {
                    nearestHospital = JSON.parse(nearestHospitalData);
                }
            } catch (e) {
                console.log("æ— æ³•è§£ææœ€è¿‘åŒ»é™¢æ•°æ®:", e);
            }
            
            if (nearestHospital && nearestHospital.longitude && nearestHospital.latitude) {
                // ä½¿ç”¨æœ€è¿‘çš„åŒ»é™¢ä½œä¸ºèµ·å§‹ç‚¹
                startPoint = new BMap.Point(nearestHospital.longitude, nearestHospital.latitude);
            } else {
                // å¦‚æœæ²¡æœ‰æœ€è¿‘çš„åŒ»é™¢ä¿¡æ¯ï¼Œåˆ™é»˜è®¤ä½¿ç”¨è¥¿å®‰äº¤é€šå¤§å­¦ç¬¬ä¸€é™„å±åŒ»é™¢
                startPoint = new BMap.Point(108.945009, 34.220307);
            }
        }

        // æ·»åŠ èµ·ç‚¹æ ‡è®°
        function addStartMarker() {
            // åˆ›å»ºèµ·ç‚¹æ ‡è®°å›¾æ ‡
            var startIcon = new BMap.Icon("data:image/svg+xml;base64," + btoa(`
                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#28a745" stroke="white" stroke-width="2"/>
                    <circle cx="12" cy="12" r="6" fill="white"/>
                    <circle cx="12" cy="12" r="3" fill="#28a745"/>
                </svg>
            `), {
                anchor: new BMap.Size(12, 12),
                imageSize: new BMap.Size(24, 24)
            });

            // åˆ›å»ºèµ·ç‚¹æ ‡è®°
            startMarker = new BMap.Marker(startPoint, { icon: startIcon });
            map.addOverlay(startMarker);

            // æ·»åŠ ä¿¡æ¯çª—å£
            var nearestHospital = null;
            try {
                var nearestHospitalData = '{{ nearest_hospital|escapejs }}';
                if (nearestHospitalData && nearestHospitalData !== 'null' && nearestHospitalData !== '') {
                    nearestHospital = JSON.parse(nearestHospitalData);
                }
            } catch (e) {
                console.log("æ— æ³•è§£ææœ€è¿‘åŒ»é™¢æ•°æ®:", e);
            }
            
            var hospitalName = nearestHospital ? nearestHospital.name : "è¥¿å®‰äº¤é€šå¤§å­¦ç¬¬ä¸€é™„å±åŒ»é™¢";
            var infoWindow = new BMap.InfoWindow("èµ·é£ç‚¹ï¼š" + hospitalName, {
                width: 200,
                height: 80
            });

            startMarker.addEventListener("click", function () {
                map.openInfoWindow(infoWindow, startPoint);
            });
        }

        // æ·»åŠ åŒ»é™¢èŠ‚ç‚¹æ ‡è®°
        function addHospitalMarkers() {
            // åŒ»é™¢æ•°æ®ä»åç«¯ä¼ é€’
            var hospitals = [];
            try {
                // å°è¯•è§£æåŒ»é™¢æ•°æ®ï¼Œå¦‚æœæ¨¡æ¿å˜é‡æœªæ­£ç¡®æ¸²æŸ“åˆ™ä½¿ç”¨ç©ºæ•°ç»„
                var hospitalsData = '{{ hospitals|escapejs }}';
                if (hospitalsData) {
                    hospitals = JSON.parse(hospitalsData);
                }
            } catch (e) {
                console.log("åŒ»é™¢æ•°æ®æœªæ­£ç¡®ä¼ é€’æˆ–ä¸ºç©º:", e);
                return;
            }
            
            // å¦‚æœæ²¡æœ‰åŒ»é™¢æ•°æ®åˆ™ç›´æ¥è¿”å›
            if (!hospitals || hospitals.length === 0) {
                console.log("æ²¡æœ‰åŒ»é™¢æ•°æ®éœ€è¦æ˜¾ç¤º");
                return;
            }
            
            // åˆ›å»ºåŒ»é™¢æ ‡è®°å›¾æ ‡ï¼ˆä¸èµ·ç‚¹æ ‡è®°ç›¸åŒå¤§å°å’Œå½¢çŠ¶ï¼Œä½†ä½¿ç”¨ä¸åŒé¢œè‰²ï¼‰
            var hospitalIcon = new BMap.Icon("data:image/svg+xml;base64," + btoa(`
                <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#17a2b8" stroke="white" stroke-width="2"/>
                    <circle cx="12" cy="12" r="6" fill="white"/>
                    <circle cx="12" cy="12" r="3" fill="#17a2b8"/>
                </svg>
            `), {
                anchor: new BMap.Size(12, 12),
                imageSize: new BMap.Size(24, 24)
            });

            // éå†åŒ»é™¢æ•°æ®å¹¶æ·»åŠ æ ‡è®°
            hospitals.forEach(function(hospital) {
                var point = new BMap.Point(hospital.longitude, hospital.latitude);
                var marker = new BMap.Marker(point, { icon: hospitalIcon });
                
                // æ·»åŠ ä¿¡æ¯çª—å£
                var infoWindow = new BMap.InfoWindow("åŒ»é™¢åç§°ï¼š" + hospital.name, {
                    width: 200,
                    height: 60
                });
                
                marker.addEventListener("click", function() {
                    map.openInfoWindow(infoWindow, point);
                });
                
                map.addOverlay(marker);
                hospitalMarkers.push(marker);
            });
        }
        
        // å¤„ç†URLå‚æ•°
        function processUrlParameters() {
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const address = "{{ address|escapejs }}";
            const orderId = urlParams.get('order_id');
            console.log('åŸå§‹åœ°å€å‚æ•°ï¼š', address);
            if (address) {
                // è§£ç åœ°å€
                const decodedAddress = decodeURIComponent(address);

                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                showLoading();

                // åˆ›å»ºåœ°å€è§£æå™¨å®ä¾‹
                var myGeo = new BMap.Geocoder();
                console.log('æ”¶åˆ°åœ°å€å‚æ•°:', decodedAddress);

                // å°†åœ°å€è§£æä¸ºåæ ‡ç‚¹
                myGeo.getPoint(decodedAddress, function (point) {
                    console.log('è§£æç»“æœ:', point);
                    hideLoading();

                    if (point) {
                        // æ£€æŸ¥æ˜¯å¦åœ¨è¥¿å®‰å¸‚èŒƒå›´å†…ï¼ˆå¤§è‡´èŒƒå›´ï¼‰
                        var isInXian = point.lng >= 108.7 && point.lng <= 109.2 &&
                            point.lat >= 34.0 && point.lat <= 34.5;

                        if (!isInXian) {
                            // æ˜¾ç¤ºæœåŠ¡èŒƒå›´é™åˆ¶çš„å¼¹çª—
                            showServiceLimitModal(decodedAddress);
                            return;
                        }

                        // ç§»åŠ¨åœ°å›¾åˆ°æ–°ä½ç½®
                        map.panTo(point);
                        map.setZoom(15); // è®¾ç½®æ›´é«˜çš„ç¼©æ”¾çº§åˆ«ä»¥ä¾¿æ›´æ¸…æ¥šåœ°çœ‹åˆ°æ ‡è®°

                        // æ·»åŠ ç»ˆç‚¹æ ‡è®°
                        addEndMarker(point, decodedAddress, orderId);

                        // ç»˜åˆ¶è·¯å¾„
                        drawRoute(startPoint, point);
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰åˆ™å¯åŠ¨é£è¡ŒåŠ¨ç”»
                        var savedPosition = getSavedFlightPosition();
                        if (!savedPosition) {
                            startFlightAnimation(); // å¯åŠ¨é£è¡ŒåŠ¨ç”»
                        } else {
                            // å¦‚æœæœ‰ä¿å­˜çš„ä½ç½®ï¼Œç›´æ¥æ¢å¤åŠ¨ç”»
                            resumeFlightAnimation();
                        }

                        showNotification('å·²å®šä½åˆ°åœ°å€: ' + decodedAddress, 'success');
                    } else {
                        showNotification('åœ°å€è§£æå¤±è´¥: ' + decodedAddress, 'error');
                    }
                }, "è¥¿å®‰å¸‚");
            }
        }

        // æ·»åŠ ç»ˆç‚¹æ ‡è®°
        function addEndMarker(point, address, orderId) {
            // åˆ›å»ºç»ˆç‚¹æ ‡è®°å›¾æ ‡ï¼ˆçº¢è‰²ï¼Œæ›´é†’ç›®ï¼‰
            var endIcon = new BMap.Icon("data:image/svg+xml;base64," + btoa(`
                <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="14" fill="#FF4757" stroke="white" stroke-width="2"/>
                    <circle cx="16" cy="16" r="8" fill="white"/>
                    <circle cx="16" cy="16" r="4" fill="#FF4757"/>
                </svg>
            `), {
                anchor: new BMap.Size(16, 16),
                imageSize: new BMap.Size(32, 32)
            });

            // åˆ›å»ºç»ˆç‚¹æ ‡è®°
            endMarker = new BMap.Marker(point, { icon: endIcon });
            map.addOverlay(endMarker);

            // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹
            var infoContent = `
                <div style="padding: 12px; min-width: 200px;">
                    <h4 style="margin: 0 0 8px 0; color: #2c3e50; font-size: 16px; font-weight: 600;">ç›®çš„åœ°</h4>
                    <p style="margin: 0 0 4px 0; color: #666; font-size: 14px;"><strong>åœ°å€ï¼š</strong>${address}</p>
            `;
            if (orderId) {
                infoContent += `<p style="margin: 0 0 8px 0; color: #666; font-size: 14px;"><strong>è®¢å•å·ï¼š</strong>${orderId}</p>`;
            }
            infoContent += `
                </div>
            `;

            // æ·»åŠ ä¿¡æ¯çª—å£
            var infoWindow = new BMap.InfoWindow(infoContent, {
                width: 250,
                height: 120
            });

            // ç‚¹å‡»äº‹ä»¶
            endMarker.addEventListener("click", function () {
                map.openInfoWindow(infoWindow, point);
            });

            // è‡ªåŠ¨æ‰“å¼€ä¿¡æ¯çª—å£
            setTimeout(function () {
                map.openInfoWindow(infoWindow, point);
            }, 1000);
        }

        // ç»˜åˆ¶è·¯å¾„
        function drawRoute(start, end) {
            // å¦‚æœå·²æœ‰è·¯å¾„ï¼Œå…ˆæ¸…é™¤
            if (routePolyline) {
                map.removeOverlay(routePolyline);
            }

            // åˆ›å»ºè·¯å¾„ç‚¹ï¼ˆæ·»åŠ ä¸€ä¸ªä¸­é—´ç‚¹ä½¿è·¯å¾„æ›´æ˜æ˜¾ï¼‰
            var points = [
                start,
                new BMap.Point((start.lng + end.lng) / 2, (start.lat + end.lat) / 2 + 0.01),
                end
            ];

            // ä¿å­˜è·¯å¾„ç‚¹ç”¨äºåŠ¨ç”»
            pointsArray = points.slice(); // ä½¿ç”¨ slice() åˆ›å»ºå‰¯æœ¬
            totalPoints = pointsArray.length;
            console.log("è·¯å¾„ç‚¹æ•°ç»„:", pointsArray);

            // åˆ›å»ºè·¯å¾„çº¿ï¼ˆåŠ ç²—åˆ° 10ï¼‰
            routePolyline = new BMap.Polyline(points, {
                strokeColor: "#17a2b8",
                strokeWeight: 10, // åŠ ç²—è·¯å¾„
                strokeOpacity: 0.8
            });
            map.addOverlay(routePolyline);
        }

        // æ¢å¤é£è¡ŒåŠ¨ç”»
        function resumeFlightAnimation() {
            if (flightMarker) {
                map.removeOverlay(flightMarker);
            }

            // åˆ›å»ºé£è¡Œå™¨å›¾æ ‡ï¼ˆçº¢è‰²å°åœ†ç‚¹ï¼‰
            var flightIcon = new BMap.Icon("data:image/svg+xml;base64," + btoa(`
                <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="8" fill="#FF4757" stroke="white" stroke-width="2"/>
                    <circle cx="10" cy="10" r="4" fill="white"/>
                </svg>
            `), {
                anchor: new BMap.Size(10, 10),
                imageSize: new BMap.Size(20, 20)
            });

            // è·å–ä¿å­˜çš„ä½ç½®çŠ¶æ€
            var savedPosition = getSavedFlightPosition();
            if (!savedPosition) {
                startFlightAnimation();
                return;
            }
            
            var startPoint = savedPosition.point;
            currentPointIndex = savedPosition.segmentIndex;
            var step = savedPosition.step;

            // åˆ›å»ºé£è¡Œå™¨æ ‡è®°
            flightMarker = new BMap.Marker(startPoint, { icon: flightIcon });
            map.addOverlay(flightMarker);

            // è®¾ç½®åŠ¨ç”»å‚æ•°
            var maxStep = 100; // åˆ†æˆ 100 æ­¥å®Œæˆä¸€æ®µè·¯å¾„
            isAnimationRunning = true;

            function animate() {
                console.log("åŠ¨ç”»çŠ¶æ€: currentPointIndex=" + currentPointIndex + ", step=" + step + ", totalPoints=" + totalPoints);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆ°è¾¾æœ€åä¸€ä¸ªç‚¹
                if (currentPointIndex >= totalPoints - 1) {
                    // å·²ç»åˆ°è¾¾ç»ˆç‚¹
                    clearInterval(animationInterval);
                    isAnimationRunning = false;
                    clearSavedFlightPosition(); // æ¸…é™¤ä¿å­˜çš„ä½ç½®
                    showDeliverySuccess();
                    return;
                }

                var fromPoint = pointsArray[currentPointIndex];
                var toPoint = pointsArray[currentPointIndex + 1];

                // è®¡ç®—å½“å‰ä½ç½®ï¼ˆæ’å€¼ï¼‰
                var ratio = step / maxStep;
                var lng = fromPoint.lng + (toPoint.lng - fromPoint.lng) * ratio;
                var lat = fromPoint.lat + (toPoint.lat - fromPoint.lat) * ratio;

                var newPos = new BMap.Point(lng, lat);
                flightMarker.setPosition(newPos);
                
                // ä¿å­˜å½“å‰ä½ç½®
                saveFlightPosition(newPos, currentPointIndex, step);

                step++;
                if (step >= maxStep) {
                    currentPointIndex++;
                    step = 0;
                }
            }

            // å¼€å§‹åŠ¨ç”»
            animationInterval = setInterval(animate, 100); // æ¯ 100ms æ›´æ–°ä¸€æ¬¡
        }

        // ä¿®æ”¹ startFlightAnimation å‡½æ•°
        function startFlightAnimation() {
            if (flightMarker) {
                map.removeOverlay(flightMarker);
            }

            // åˆ›å»ºé£è¡Œå™¨å›¾æ ‡ï¼ˆçº¢è‰²å°åœ†ç‚¹ï¼‰
            var flightIcon = new BMap.Icon("data:image/svg+xml;base64," + btoa(`
                <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="10" cy="10" r="8" fill="#FF4757" stroke="white" stroke-width="2"/>
                    <circle cx="10" cy="10" r="4" fill="white"/>
                </svg>
            `), {
                anchor: new BMap.Size(10, 10),
                imageSize: new BMap.Size(20, 20)
            });

            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä½ç½®çŠ¶æ€
            var savedPosition = getSavedFlightPosition();
            var startPoint = savedPosition ? savedPosition.point : pointsArray[0];
            currentPointIndex = savedPosition ? savedPosition.segmentIndex : 0;
            var step = savedPosition ? savedPosition.step : 0;

            // åˆ›å»ºé£è¡Œå™¨æ ‡è®°
            flightMarker = new BMap.Marker(startPoint, { icon: flightIcon });
            map.addOverlay(flightMarker);

            // è®¾ç½®åŠ¨ç”»å‚æ•°
            var maxStep = 100; // åˆ†æˆ 100 æ­¥å®Œæˆä¸€æ®µè·¯å¾„
            isAnimationRunning = true;

            function animate() {
                console.log("åŠ¨ç”»çŠ¶æ€: currentPointIndex=" + currentPointIndex + ", step=" + step + ", totalPoints=" + totalPoints);
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆ°è¾¾æœ€åä¸€ä¸ªç‚¹
                if (currentPointIndex >= totalPoints - 1) {
                    // å·²ç»åˆ°è¾¾ç»ˆç‚¹
                    clearInterval(animationInterval);
                    isAnimationRunning = false;
                    clearSavedFlightPosition(); // æ¸…é™¤ä¿å­˜çš„ä½ç½®
                    showDeliverySuccess();
                    return;
                }

                var fromPoint = pointsArray[currentPointIndex];
                var toPoint = pointsArray[currentPointIndex + 1];

                // è®¡ç®—å½“å‰ä½ç½®ï¼ˆæ’å€¼ï¼‰
                var ratio = step / maxStep;
                var lng = fromPoint.lng + (toPoint.lng - fromPoint.lng) * ratio;
                var lat = fromPoint.lat + (toPoint.lat - fromPoint.lat) * ratio;

                var newPos = new BMap.Point(lng, lat);
                flightMarker.setPosition(newPos);
                
                // ä¿å­˜å½“å‰ä½ç½®
                saveFlightPosition(newPos, currentPointIndex, step);

                step++;
                if (step >= maxStep) {
                    currentPointIndex++;
                    step = 0;
                }
            }

            // å¼€å§‹åŠ¨ç”»
            animationInterval = setInterval(animate, 100); // æ¯ 100ms æ›´æ–°ä¸€æ¬¡
        }

        // ä¿å­˜é£è¡Œå™¨ä½ç½®åˆ° localStorage
        function saveFlightPosition(point, segmentIndex, step) {
            var positionData = {
                point: {
                    lng: point.lng,
                    lat: point.lat
                },
                segmentIndex: segmentIndex,
                step: step,
                timestamp: new Date().getTime()
            };
            
            // åªä¿å­˜è®¢å•ç›¸å…³çš„é£è¡Œä½ç½®
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            if (orderId) {
                localStorage.setItem('flightPosition_' + orderId, JSON.stringify(positionData));
            }
        }

        // æ¸…é™¤ä¿å­˜çš„é£è¡Œå™¨ä½ç½®
        function clearSavedFlightPosition() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            if (orderId) {
                localStorage.removeItem('flightPosition_' + orderId);
            }
        }

        // è·å–ä¿å­˜çš„é£è¡Œå™¨ä½ç½®
        function getSavedFlightPosition() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            if (!orderId) return null;
            
            var savedData = localStorage.getItem('flightPosition_' + orderId);
            if (!savedData) return null;
            
            try {
                var positionData = JSON.parse(savedData);
                // æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡1å°æ—¶æ¸…é™¤ï¼‰
                var now = new Date().getTime();
                if (now - positionData.timestamp > 3600000) { // 1å°æ—¶
                    localStorage.removeItem('flightPosition_' + orderId);
                    return null;
                }
                
                positionData.point = new BMap.Point(positionData.point.lng, positionData.point.lat);
                return positionData;
            } catch (e) {
                console.error("è§£æä¿å­˜çš„ä½ç½®æ•°æ®å¤±è´¥:", e);
                localStorage.removeItem('flightPosition_' + orderId);
                return null;
            }
        }

        // æ˜¾ç¤ºé…é€æˆåŠŸä¿¡æ¯
        function showDeliverySuccess() {
            console.log("è°ƒç”¨ showDeliverySuccess å‡½æ•°");
            
            // æ¸…é™¤ä¿å­˜çš„é£è¡Œä½ç½®
            clearSavedFlightPosition();
            
            // è·å–URLä¸­çš„order_idå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            
            // å¦‚æœæ²¡æœ‰orderIdï¼Œåˆ™ä¸å‘é€è¯·æ±‚ï¼ˆå¯èƒ½æ˜¯æµ‹è¯•æƒ…å†µï¼‰
            if (!orderId) {
                console.warn('æœªæ‰¾åˆ°è®¢å•IDï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°');
                showSuccessMarkerAndInfo();
                return;
            }
        
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            showLoading();
        
            // å‘é€è¯·æ±‚åˆ°åç«¯ï¼Œæ›´æ–°è®¢å•çŠ¶æ€
            fetch('/execute_success/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken() // å¦‚æœä½¿ç”¨Djangoç­‰æ¡†æ¶éœ€è¦CSRF token
                },
                body: JSON.stringify({
                    order_id: orderId,
                    status: 'completed' // å¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µå¦‚å®Œæˆæ—¶é—´ç­‰
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
                }
                return response.json();
            })
            .then(data => {
                console.log('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ:', data);
                showSuccessMarkerAndInfo(); // æ˜¾ç¤ºæˆåŠŸæ ‡è®°å’Œä¿¡æ¯çª—å£
            })
            .catch(error => {
                console.error('è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                showNotification('é…é€æˆåŠŸï¼Œä½†çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                showSuccessMarkerAndInfo(); // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºæˆåŠŸæ ‡è®°
            })
            .finally(() => {
                hideLoading();
            });
        }

        // æå–æ˜¾ç¤ºæˆåŠŸæ ‡è®°å’Œä¿¡æ¯çª—å£çš„é€»è¾‘
        function showSuccessMarkerAndInfo() {
            // è·å–ç»ˆç‚¹åæ ‡
            var endPoint = pointsArray[pointsArray.length - 1];
            
            // åˆ›å»ºé…é€æˆåŠŸå›¾æ ‡
            var successIcon = new BMap.Icon("data:image/svg+xml;base64," + btoa(`
                <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="14" fill="#28a745" stroke="white" stroke-width="2"/>
                    <path d="M10 16l4 4 8-8" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `), {
                anchor: new BMap.Size(16, 16),
                imageSize: new BMap.Size(32, 32)
            });
            
            // åˆ›å»ºé…é€æˆåŠŸæ ‡è®°
            var successMarker = new BMap.Marker(endPoint, { icon: successIcon });
            map.addOverlay(successMarker);
            
            // åˆ›å»ºä¿¡æ¯çª—å£
            var infoWindow = new BMap.InfoWindow(`
                <div style="padding: 15px; min-width: 200px; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; color: #28a745; font-size: 18px;">
                        <i class="fas fa-check-circle"></i> é…é€æˆåŠŸ
                    </h3>
                    <p style="margin: 0 0 5px 0; color: #333; font-size: 14px;">
                        æ‚¨çš„è¯å“å·²æˆåŠŸé€è¾¾ï¼
                    </p>
                    <p style="margin: 0; color: #666; font-size: 12px;">
                        æ„Ÿè°¢æ‚¨é€‰æ‹©åŒ»é£é€Ÿè¾¾æœåŠ¡
                    </p>
                </div>
            `, {
                width: 220,
                height: 120,
                title: "é…é€å®Œæˆ",
                enableAutoPan: true
            });
            
            // æ‰“å¼€ä¿¡æ¯çª—å£
            map.openInfoWindow(infoWindow, endPoint);
            
            // æ˜¾ç¤ºé€šçŸ¥
            showNotification('é…é€æˆåŠŸï¼è¯å“å·²é€è¾¾ç›®çš„åœ°ã€‚', 'success');
        }
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function showLoading() {
            loading.style.display = 'block';
        }

        // éšè—åŠ è½½åŠ¨ç”»
        function hideLoading() {
            loading.style.display = 'none';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            var notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.textContent = message;

            // è®¾ç½®èƒŒæ™¯è‰²
            switch (type) {
                case 'success':
                    notification.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    break;
                case 'error':
                    notification.style.background = 'linear-gradient(135deg, #dc3545, #e83e8c)';
                    break;
                default:
                    notification.style.background = 'linear-gradient(135deg, #17a2b8, #6f42c1)';
            }

            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(notification);

            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(function () {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            // è‡ªåŠ¨éšè—
            setTimeout(function () {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(function () {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºæœåŠ¡èŒƒå›´é™åˆ¶çš„å¼¹çª—
        function showServiceLimitModal(address) {
            // åˆ›å»ºæ¨¡æ€æ¡†å…ƒç´ 
            var modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay show';
            
            var modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.innerHTML = `
                <div class="modal-icon">âš ï¸</div>
                <h2 class="modal-title">æœåŠ¡èŒƒå›´é™åˆ¶</h2>
                <p class="modal-message">å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„åœ°å€è¶…å‡ºäº†æˆ‘ä»¬çš„æœåŠ¡èŒƒå›´ã€‚æˆ‘ä»¬ç›®å‰ä»…åœ¨è¥¿å®‰å¸‚ä¸»åŸåŒºæä¾›é…é€æœåŠ¡ã€‚</p>
                <div class="modal-location">
                    <strong>æ‚¨è¾“å…¥çš„åœ°å€ï¼š</strong><br>
                    ${address}
                </div>
                <div class="service-features">
                    <h4>æˆ‘ä»¬çš„æœåŠ¡èŒƒå›´åŒ…æ‹¬ï¼š</h4>
                    <ul>
                        <li>è¥¿å®‰å¸‚ä¸»åŸåŒº</li>
                        <li>ç»çº¬åº¦èŒƒå›´ï¼šä¸œç»108.7Â°-109.2Â°ï¼ŒåŒ—çº¬34.0Â°-34.5Â°</li>
                        <li>è¦†ç›–ä¸»è¦åŒ»é™¢å’Œç¤¾åŒº</li>
                    </ul>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="this.closest('.modal-overlay').remove()">å…³é—­</button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            
            // æ·»åŠ å…³é—­äº‹ä»¶
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    modalOverlay.remove();
                }
            });
        }

        // æ˜¾ç¤ºåŒ»é™¢é€‰æ‹©ç†ç”±
        function showSelectionReasons() {
            console.log("å¼€å§‹æ˜¾ç¤ºåŒ»é™¢é€‰æ‹©ç†ç”±...");
            
            try {
                // è·å–ä»åç«¯ä¼ é€’çš„é€‰æ‹©ç†ç”±æ•°æ®
                var selectionReasons = {{ selection_reasons|safe }} || [];
                var distance = parseFloat("{{ distance|default:0 }}");
                var inventoryMatch = parseFloat("{{ inventory_match|default:0 }}");
                
                console.log("é€‰æ‹©ç†ç”±æ•°æ®:", selectionReasons);
                console.log("è·ç¦»:", distance);
                console.log("åº“å­˜åŒ¹é…åº¦:", inventoryMatch);
                
                // å¦‚æœæœ‰é€‰æ‹©ç†ç”±æ•°æ®ï¼Œåˆ™åœ¨é¡µé¢ä¸­æ˜¾ç¤º
                if (selectionReasons.length > 0) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨é€‰æ‹©ç†ç”±å…ƒç´ ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆç§»é™¤
                    var existingReasons = document.getElementById('hospital-selection-reasons');
                    if (existingReasons) {
                        existingReasons.remove();
                    }
                    
                    // åˆ›å»ºç†ç”±æ˜¾ç¤ºåŒºåŸŸ
                    var reasonsContainer = document.createElement('div');
                    reasonsContainer.id = 'hospital-selection-reasons';
                    reasonsContainer.className = 'selection-reasons';
                    
                    // åˆ›å»ºæ ‡é¢˜
                    var title = document.createElement('h3');
                    // åŒ»é™¢å‰é¢åŠ ä¸Šåç§°,å³XXåŒ»é™¢
                    try {
                        var nearestHospitalData = '{{ nearest_hospital|escapejs }}';
                        var hospitalName = "åŒ»é™¢";
                        if (nearestHospitalData && nearestHospitalData !== 'null' && nearestHospitalData !== '') {
                            var nearestHospital = JSON.parse(nearestHospitalData);
                            if (nearestHospital && nearestHospital.name) {
                                hospitalName = nearestHospital.name;
                            }
                        }
                        title.textContent = hospitalName;
                    } catch (e) {
                        console.log("è§£æåŒ»é™¢åç§°å¤±è´¥:", e);
                        title.textContent = 'åŒ»é™¢';
                    }
                    reasonsContainer.appendChild(title);
                    
                    // åˆ›å»ºç†ç”±åˆ—è¡¨
                    var reasonsList = document.createElement('ul');
                    selectionReasons.forEach(function(reason) {
                        var listItem = document.createElement('li');
                        listItem.textContent = reason;
                        reasonsList.appendChild(listItem);
                    });
                    reasonsContainer.appendChild(reasonsList);
                    
                    // åˆ›å»ºè¯¦ç»†ä¿¡æ¯åŒºåŸŸ
                    var detailsContainer = document.createElement('div');
                    detailsContainer.className = 'selection-details';
                    
                    var distanceInfo = document.createElement('p');
                    distanceInfo.innerHTML = '<strong>è·ç¦»:</strong> ' + distance.toFixed(2) + ' å…¬é‡Œ';
                    
                    var inventoryInfo = document.createElement('p');
                    inventoryInfo.innerHTML = '<strong>åº“å­˜åŒ¹é…åº¦:</strong> ' + (inventoryMatch * 100).toFixed(1) + '%';
                    
                    detailsContainer.appendChild(distanceInfo);
                    detailsContainer.appendChild(inventoryInfo);
                    reasonsContainer.appendChild(detailsContainer);
                    
                    // å°†ç†ç”±åŒºåŸŸæ·»åŠ åˆ°é¡µé¢bodyä¸­ï¼ˆè€Œä¸æ˜¯æ§åˆ¶é¢æ¿ï¼‰
                    document.body.appendChild(reasonsContainer);
                    console.log("æˆåŠŸæ·»åŠ åŒ»é™¢é€‰æ‹©ç†ç”±åˆ°é¡µé¢å·¦ä¸Šè§’");
                }
            } catch (e) {
                console.error("æ˜¾ç¤ºé€‰æ‹©ç†ç”±æ—¶å‡ºé”™:", e);
            }
        }

        // è·å–CSRF Tokenï¼ˆå¦‚æœä½¿ç”¨Djangoç­‰æ¡†æ¶ï¼‰
        function getCSRFToken() {
            const cookieValue = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
            return cookieValue ? cookieValue.pop() : '';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾");
            // ç­‰å¾…ç™¾åº¦åœ°å›¾APIåŠ è½½å®Œæˆ
            if (typeof BMap !== 'undefined') {
                initMap();
            } else {
                // å¦‚æœAPIè¿˜æœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
                var checkBMap = setInterval(function () {
                    if (typeof BMap !== 'undefined') {
                        clearInterval(checkBMap);
                        console.log("ç™¾åº¦åœ°å›¾APIåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–");
                        initMap();
                    }
                }, 100);
            }
        });
        // æ·»åŠ æ£€æŸ¥è®¢å•é…é€è·¯å¾„çš„å‡½æ•°
    function checkOrderRoute(orderId) {
        if (!orderId) {
            showNotification('è®¢å•IDä¸èƒ½ä¸ºç©º', 'error');
            return;
        }
        
        showLoading();
        
        // è°ƒç”¨ check_order æ¥å£
        fetch(`/route/check_order/?order_id=${encodeURIComponent(orderId)}`)
            .then(response => {
                hideLoading();
                if (response.redirected) {
                    // å¦‚æœè¿”å›çš„æ˜¯é‡å®šå‘åˆ° route_map.html çš„å“åº”ï¼Œåˆ™é‡æ–°åŠ è½½é¡µé¢
                    window.location.href = response.url;
                } else if (response.headers.get('content-type')?.includes('application/json')) {
                    // å¦‚æœè¿”å›çš„æ˜¯ JSON æ•°æ®
                    return response.json().then(data => {
                        if (data.status === 'success') {
                            showNotification('è·¯å¾„æ£€æŸ¥å®Œæˆ', 'success');
                            // å¤„ç†è¿”å›çš„æ•°æ®
                            handleRouteCheckResult(data);
                        } else {
                            showNotification(data.message || 'è·¯å¾„æ£€æŸ¥å¤±è´¥', 'error');
                        }
                    });
                } else {
                    // å¦‚æœè¿”å›çš„æ˜¯ HTML é¡µé¢
                    window.location.reload();
                }
            })
            .catch(error => {
                hideLoading();
                console.error('æ£€æŸ¥è®¢å•è·¯å¾„æ—¶å‡ºé”™:', error);
                showNotification('æ£€æŸ¥è®¢å•è·¯å¾„æ—¶å‡ºé”™: ' + error.message, 'error');
            });
    }

    // å¤„ç†è·¯ç”±æ£€æŸ¥ç»“æœ
    function handleRouteCheckResult(data) {
        // æ ¹æ®è¿”å›çš„åŠ¨ä½œç±»å‹è¿›è¡Œä¸åŒçš„å¤„ç†
        if (data.action === 'select_hospital' && data.hospital) {
            // å¦‚æœæ˜¯é€‰æ‹©åŒ»é™¢çš„åŠ¨ä½œï¼Œåœ¨åœ°å›¾ä¸Šæ ‡å‡ºåŒ»é™¢ä½ç½®
            showNotification(`æ¨èåŒ»é™¢: ${data.hospital.name}`, 'info');
            // è¿™é‡Œå¯ä»¥æ·»åŠ åœ¨åœ°å›¾ä¸Šæ ‡æ³¨åŒ»é™¢çš„é€»è¾‘
            
        } else if (data.action === 'wait_for_restock') {
            showNotification(data.message || 'å»ºè®®ç­‰å¾…åŒ»é™¢è¡¥è´§', 'info');
            
        } else if (data.action === 'redirect_alternative') {
            showNotification(data.message || 'å»ºè®®é‡å®šå‘åˆ°æ›¿ä»£æ–¹æ¡ˆ', 'info');
            
        } else if (data.action === 'split_order') {
            showNotification(data.message || 'å»ºè®®æ‹†åˆ†è®¢å•', 'info');
            
        } else {
            showNotification(data.message || `æ‰§è¡Œé»˜è®¤åŠ¨ä½œï¼Œç´¢å¼• ${data.action_index}`, 'info');
        }
    }
    </script>
    {% include 'footer.html' %}
</body>
</html>